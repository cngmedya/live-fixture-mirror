name: Sheet → JSON sync

on:
  schedule:
    - cron: "*/5 * * * *"   # her 5 dakikada bir
  workflow_dispatch:        # istersek manuel tetikleme

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SHEET_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvj3Rq3R1Q2kpXiBoF1_bN46Ag0Ly5KZgZJmTfFLYy5nWb2XK9kH3DB3CbbJ9RqVm1A_YRv620BV1P/pub?gid=1679302956&single=true&output=tsv"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch live sheet (TSV) and convert to JSON
        run: |
          mkdir -p data
          curl -fsSL "$SHEET_URL" -o data/live.tsv
          python - <<'PY'
import csv, json, io
txt = open("data/live.tsv","r",encoding="utf-8").read()
delim = "\t" if txt.count("\t") >= txt.count(",") else ","
rows = list(csv.DictReader(io.StringIO(txt), delimiter=delim))
# boşları None yap, anahtarları normalize et
norm = []
for r in rows:
    norm.append({(k or "").strip(): (v.strip() if isinstance(v,str) else v) or None for k,v in r.items()})
open("data/live.json","w",encoding="utf-8").write(json.dumps(norm, ensure_ascii=False))
PY

      - name: Commit & push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "sheet-bot"
          git config user.email "sheet-bot@users.noreply.github.com"
          git add data/live.tsv data/live.json
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "Update live sheet $(date -u +'%F %T')"
          git push
