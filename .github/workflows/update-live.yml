name: Update live.json from Google Sheet

on:
  workflow_dispatch: {}
  schedule:
    # UTC çalışır. Aşağıdaki 5 dakikada bir, 06:00–23:59 TRT (UTC+3) eşleniği:
    - cron: "*/5 3-20 * * *"

permissions:
  contents: write

concurrency:
  group: live-json
  cancel-in-progress: false

jobs:
  pull-sheet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch TSV (public Sheet)
        run: |
          curl -fsSL "${{ secrets.SHEET_TSV_URL }}" -o /tmp/live.tsv

      - name: Convert TSV → JSON
        run: |
          node -e '
          const fs=require("fs");
          const txt=fs.readFileSync("/tmp/live.tsv","utf8").trim();
          const [hdr,...rows]=txt.split(/\r?\n/).map(l=>l.split("\t"));
          const out=rows.map(r=>Object.fromEntries(hdr.map((h,i)=>[h, r[i]??""])));
          fs.mkdirSync("data",{recursive:true});
          fs.writeFileSync("data/live.json", JSON.stringify(out));
          '

      - name: Commit & push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update live.json from Sheet"
          file_pattern: data/live.json
